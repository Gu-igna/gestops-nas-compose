<div class="flex justify-center">
    <div class="w-full max-w-98/100">
        <div class="flex justify-around">
            <div class="pt-2">
                <button mat-raised-button (click)="openCreateDialog()">
                    <mat-icon>add_box</mat-icon>
                    Crear operación
                </button>
            </div>
            <div class="flex flex-row">
                <mat-form-field class="text-xs w-[220px]">
                    <mat-label>Filtro global</mat-label>
                    <input matInput [(ngModel)]="filtroGlobal"
                        (input)="applyFilter('global', $any($event.target).value)"
                        placeholder="Buscar en todas las columnas...">
                </mat-form-field>
                <div>
                    <button mat-button (click)="clearFilters()" class="mt-2">
                        <mat-icon>clear</mat-icon>
                        Limpiar Filtros
                    </button>
                </div>
            </div>
            <div>
                <button mat-fab extended (click)="downloadExcel()" [disabled]="isDownloadingExcel">
                    <mat-icon>browser_updated</mat-icon>
                    {{isDownloadingExcel ? 'Descargando...' : 'Descargar Excel'}}
                </button>
            </div>
        </div>

        <div class="mat-elevation-z8">
            <table mat-table [dataSource]="dataSource" multiTemplateDataRows matSort
                class="border border-gray-500 table-fixed">

                @for (column of columnsToDisplay; track column) {
                <ng-container matColumnDef="{{column}}">
                    <th mat-header-cell *matHeaderCellDef [class]="headerColor" mat-sort-header
                        [ngClass]="getColumnWidthClass(column) + ' no-padding'">
                        {{column === 'subcategoria' ? 'Subcategoría' :
                        column === 'categoria' ? 'Categoría' :
                        column === 'razon_social' ? 'Razón social' :
                        column === 'option' ? 'Tipo de comprobante' :
                        column === 'codigo' ? 'Número de comprobante' :
                        column === 'monto_total' ? 'Importe' :
                        (column | titlecase).split('_').join(' ')}}
                    </th>

                    <td mat-cell *matCellDef="let element" [ngClass]="getColumnWidthClass(column) + ' no-padding'">
                        {{element[column]}}
                    </td>
                </ng-container>
                }

                @for (column of columnsToDisplay; track column) {
                <ng-container matColumnDef="{{column}}-filter">
                    <th mat-header-cell *matHeaderCellDef [ngClass]="getColumnWidthClass(column)"
                        class="bg-[#ffffff] border-b border-gray-500 p-1 filter-cell">

                        @if (column === 'id') {
                        <div class="relative w-[86px]">
                            <input type="text" id="filtro_id"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroId"
                                (input)="applyFilter('id', $any($event.target).value)" />
                            <label for="filtro_id"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'fecha') {
                        <div class="relative w-[104px]">
                            <input type="text" id="filtro_fecha"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroFecha"
                                (input)="applyFilter('fecha', $any($event.target).value)" />
                            <label for="filtro_fecha"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'tipo') {
                        <div class="relative w-[86px]">
                            <input type="text" id="filtro_tipo"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroTipo"
                                (input)="applyFilter('tipo', $any($event.target).value)" />
                            <label for="filtro_tipo"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'caracter') {
                        <div class="relative w-[86px]">
                            <input type="text" id="filtro_caracter"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroCaracter"
                                (input)="applyFilter('caracter', $any($event.target).value)" />
                            <label for="filtro_caracter"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'naturaleza') {
                        <div class="relative w-[104px]">
                            <input type="text" id="filtro_naturaleza"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroNaturaleza"
                                (input)="applyFilter('naturaleza', $any($event.target).value)" />
                            <label for="filtro_naturaleza"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'concepto') {
                        <div class="relative w-[104px]">
                            <input type="text" id="filtro_concepto"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroConcepto"
                                (input)="applyFilter('concepto', $any($event.target).value)" />
                            <label for="filtro_concepto"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'categoria') {
                        <div class="relative w-[164px]">
                            <input type="text" id="filtro_categoria"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroCategoria"
                                (input)="applyFilter('categoria', $any($event.target).value)" />
                            <label for="filtro_categoria"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'subcategoria') {
                        <div class="relative w-[164px]">
                            <input type="text" id="filtro_subcategoria"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroSubcategoria"
                                (input)="applyFilter('subcategoria', $any($event.target).value)" />
                            <label for="filtro_subcategoria"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'razon_social') {
                        <div class="relative w-[136px]">
                            <input type="text" id="filtro_razon_social"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroPersona"
                                (input)="applyFilter('persona', $any($event.target).value)" />
                            <label for="filtro_razon_social"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'cuit') {
                        <div class="relative w-[112px]">
                            <input type="text" id="filtro_cuit"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroCuit"
                                (input)="applyFilter('cuit', $any($event.target).value)" />
                            <label for="filtro_cuit"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'option') {
                        <div class="relative w-[108px]">
                            <input type="text" id="filtro_option"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroOption"
                                (input)="applyFilter('option', $any($event.target).value)" />
                            <label for="filtro_option"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'codigo') {
                        <div class="relative w-[156px]">
                            <input type="text" id="filtro_codigo"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroCodigo"
                                (input)="applyFilter('codigo', $any($event.target).value)" />
                            <label for="filtro_codigo"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'monto_total') {
                        <div class="relative w-[122px]">
                            <input type="text" id="filtro_monto_total"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroMonto"
                                (input)="applyFilter('monto', $any($event.target).value)" />
                            <label for="filtro_monto_total"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                        @if (column === 'usuario') {
                        <div class="relative w-[104px]">
                            <input type="text" id="filtro_usuario"
                                class="peer block w-full rounded-t-md border-b px-2.5 pb-2 pt-4 text-xs bg-[var(--mat-sys-surface-variant)] h-[42px] font-normal focus:outline-none focus:ring-0 focus:border-[var(--mat-sys-primary)]"
                                placeholder=" "
                                [(ngModel)]="filtroUsuario"
                                (input)="applyFilter('usuario', $any($event.target).value)" />
                            <label for="filtro_usuario"
                                class="absolute left-2.5 top-3.5 origin-[0] -translate-y-3 scale-75 transform cursor-text text-[var(--mat-sys-on-surface-variant)] duration-300 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-120 peer-focus:-translate-y-3 peer-focus:scale-85 peer-focus:text-[var(--mat-sys-primary)] font-normal">
                                Buscar...
                            </label>
                        </div>
                        }

                    </th>
                </ng-container>
                }

                <ng-container matColumnDef="expand">
                    <th mat-header-cell *matHeaderCellDef aria-label="row actions" [class]="headerColor"
                        class="w-[73px] no-padding">&nbsp;</th>
                    <td mat-cell *matCellDef="let element" class="no-padding">
                        <button mat-icon-button aria-label="expand row"
                            (click)="toggle(element); $event.stopPropagation()" class="operation-toggle-button"
                            [class.operation-toggle-button-expanded]="isExpanded(element)">
                            <mat-icon>keyboard_arrow_down</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <ng-container matColumnDef="expand-filter">
                    <th mat-header-cell *matHeaderCellDef
                        class="w-[73px] bg-gray-50 border-b border-gray-200 no-padding filter-cell">
                        &nbsp;
                    </th>
                </ng-container>

                <ng-container matColumnDef="expandedDetail">
                    <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplayWithExpand.length">
                        <div class="operation-element-detail-wrapper"
                            [class.operation-element-detail-wrapper-expanded]="isExpanded(element)">
                            <div class="operation-element-detail">
                                <div class="flex flex-row">
                                    <div class="flex-col mr-1 ml-1 min-w-35 justify-items-center">
                                        <p class="mt-2.5">Comprobante:</p>
                                        @if (element.comprobante_path) {
                                        <button mat-button
                                            (click)="openFileViewer(element.comprobante_path, 'Comprobante', 'document', element.id)">
                                            <mat-icon class="align-middle mr-1">description</mat-icon>
                                            Ver archivo
                                        </button>
                                        } @else {
                                        <button mat-button disabled>
                                            <mat-icon class="align-middle mr-1 text-gray-400">description</mat-icon>
                                            No disponible
                                        </button>
                                        }
                                    </div>
                                    <div class="flex-col mr-1 ml-1 min-w-35 justify-items-center">
                                        <p class="mt-2.5">Archivo1:</p>
                                        @if (element.archivo1_path) {
                                        <button mat-button
                                            (click)="openFileViewer(element.archivo1_path, 'Archivo 1', 'document', element.id)">
                                            <mat-icon class="align-middle mr-1">description</mat-icon>
                                            Ver archivo1
                                        </button>
                                        } @else {
                                        <button mat-button disabled>
                                            <mat-icon class="align-middle mr-1 text-gray-400">description</mat-icon>
                                            No disponible
                                        </button>
                                        }
                                    </div>
                                    <div class="flex-col mr-1 ml-1 min-w-35 justify-items-center">
                                        <p class="mt-2.5">Archivo2:</p>
                                        @if (element.archivo2_path) {
                                        <button mat-button
                                            (click)="openFileViewer(element.archivo2_path, 'Archivo 2', 'document', element.id)">
                                            <mat-icon class="align-middle mr-1">description</mat-icon>
                                            Ver archivo2
                                        </button>
                                        } @else {
                                        <button mat-button disabled>
                                            <mat-icon class="align-middle mr-1 text-gray-400">description</mat-icon>
                                            No disponible
                                        </button>
                                        }
                                    </div>
                                    <div class="flex-col mr-1 ml-1 min-w-35 justify-items-center">
                                        <p class="mt-2.5">Archivo3:</p>
                                        @if (element.archivo3_path) {
                                        <button mat-button
                                            (click)="openFileViewer(element.archivo3_path, 'Archivo 3', 'document', element.id)">
                                            <mat-icon class="align-middle mr-1">description</mat-icon>
                                            Ver archivo3
                                        </button>
                                        } @else {
                                        <button mat-button disabled>
                                            <mat-icon class="align-middle mr-1 text-gray-400">description</mat-icon>
                                            No disponible
                                        </button>
                                        }
                                    </div>
                                    <div class="flex-col mr-1 ml-1 min-w-35 justify-items-center self-center">
                                        <p>Método de pago:</p>
                                        <p>{{element.metodo_de_pago}}</p>
                                    </div>
                                    <div class="flex-col mr-3 ml-3 w-200 justify-items-center self-center">
                                        <p>Observaciones:</p>
                                        <p>{{element.observaciones}}</p>
                                    </div>
                                    <div class="flex-col mr-10 ml-3 mix-w-30 max-w-30 self-center text-center">
                                        @if (element.modificado_por_otro) {
                                        <p>Modificado por otro</p>
                                        } @else {
                                        <p>Sin modificar</p>
                                        }
                                    </div>
                                    <div class="flex-col mr-6 ml-3 justify-items-center">
                                        <button mat-mini-fab class=" bg-amber-500/65 mt-3.5"
                                            (click)="openUpdateDialog(element.id)">
                                            <mat-icon>edit_squared_outlined</mat-icon>
                                        </button>
                                    </div>
                                    <div class="flex-col mr-3 ml-3 justify-items-center">
                                        <button mat-mini-fab class="bg-red-500/75 mt-3.5"
                                            (click)="openDeleteOperationDialog(element.id)">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand; sticky: false"></tr>

                <tr mat-header-row *matHeaderRowDef="filterColumns; sticky: false" class="bg-gray-50"></tr>

                <tr mat-row *matRowDef="let element; columns: columnsToDisplayWithExpand;" class="operation-element-row"
                    [class.operation-expanded-row]="isExpanded(element)" (click)="toggle(element)">
                </tr>
                <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="operation-detail-row"></tr>
            </table>
            <mat-paginator [pageSizeOptions]="[10, 20, 50, 100]" [length]="totalOperaciones" [pageSize]="pageSize"
                [pageIndex]="currentPage - 1" (page)="onPageChange($event)" showFirstLastButtons
                aria-label="Select page of periodic elements" class="bg-gray-300">
            </mat-paginator>
        </div>

        <div class=" mt-10 mb-5">
            <mat-card class="rounded-none" style="background-color: var(--mat-sys-surface-variant);">
                <mat-card-content style="border: 1px solid var(--mat-sys-outline);">
                    <div class="flex flex-row justify-around">
                        <div>
                            <span class="font-bold">Total:&nbsp;&nbsp;</span>
                            <span class="font-bold text-gray-700">ARS {{formatNumber(totalGeneral)}}</span>
                        </div>
                        <div>
                            <span class="font-bold">Ingresos:&nbsp;&nbsp;</span>
                            <span class="font-bold text-green-700">ARS {{formatNumber(totalIngresos)}}</span>
                        </div>
                        <div>
                            <span class="font-bold">Egresos:&nbsp;&nbsp;</span>
                            <span class="font-bold text-red-600">ARS {{formatNumber(totalEgresos)}}</span>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>
    </div>
</div>